name: CD
on:
  workflow_call:
    inputs:
      semantic_release:
        description: The complete output of action-semantic-release as JSON
        required: true
        type: string

env:
  solution: ./protoc-gen-twincat.slnx
  csproj: ./src/protoc-gen-twincat/protoc-gen-twincat.csproj
  dotnet_versions: 10.0.x
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: 1

jobs:
  cd-protoc-gen-twincat:
    name: CD - protoc-gen-twincat
    strategy:
      matrix:
        # Use 'include' to define explicit OS/runtime pairs (avoid cartesian product)
        include:
          - os: ubuntu-latest
            runtime: linux-x64
            dist_dir: ./dist/linux-x64
            zip_name: linux-x64.zip
          - os: windows-2022
            runtime: win-x64
            dist_dir: ./dist/win-x64
            zip_name: win-x64.zip

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    env:
      new_release_version: ${{ fromJson(fromJson(inputs.semantic_release).semantic_release).new_release_version }}
      release_tag: ${{ fromJson(fromJson(inputs.semantic_release).semantic_release).new_release_git_tag }}

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.dotnet_versions }}

      # - name: Publish AOT
      #   run: |
      #         dotnet publish ${{ env.csproj }} -c Release -r ${{ matrix.runtime }} -o ${{ matrix.dist_dir }} --self-contained true /p:PublishAot=true /p:SuppressTrimAnalysisWarnings=true /p:SuppressAotAnalysisWarnings=true /p:Version=${{ env.new_release_version }}
      
      - name: Publish self-contained
        run: |
              dotnet publish ${{ env.csproj }} -c Release -r ${{ matrix.runtime }} -o ${{ matrix.dist_dir }} --self-contained true /p:PublishTrimmed=true /p:TrimMode=partial /p:PublishSingleFile=true /p:SuppressTrimAnalysisWarnings=true /p:Version=${{ env.new_release_version }}

      - name: Copy tchaxx-extensions.proto
        run: |
          mkdir -p ${{ matrix.dist_dir }}/include
          cp proto/tchaxx-extensions.proto ${{ matrix.dist_dir }}/include

      - name: Zip output (Linux)
        if: ${{ runner.os == 'Linux' }}
        run: |
          zip -r ${{ matrix.zip_name }} ${{ matrix.dist_dir }}

      - name: Zip output (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          $dist = "${{ matrix.dist_dir }}"
          if (Test-Path $dist) {
            Compress-Archive -Path (Join-Path $dist '*') -DestinationPath "${{ matrix.zip_name }}" -Force
          } else {
            Write-Error "Dist dir not found: $dist"
          }

      - name: Upload Release asset (Linux)
        if: ${{ runner.os == 'Linux' && env.release_tag != '' }}
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh release upload "${{ env.release_tag }}" "${{ matrix.zip_name }}" --clobber

      - name: Upload Release asset (Windows)
        if: ${{ runner.os == 'Windows' && env.release_tag != '' }}
        shell: pwsh
        run: |
          $token = "${{ secrets.GITHUB_TOKEN }}"
          $token | gh auth login --with-token
          gh release upload "${{ env.release_tag }}" "${{ matrix.zip_name }}" --clobber
